# 文件搜索工具对比分析

## 两个组件的区别

### 1. FilesystemFileSearchMiddleware (435-439行)

**类型**: LangChain 内置中间件

**提供的工具**:
- `glob_search`: 文件名模式匹配（如 `*.md`, `**/config.*`）
- `grep_search`: 使用 ripgrep 的正则表达式文本搜索

**特点**:
- ✅ 通用文件系统搜索能力
- ✅ 使用 ripgrep，搜索速度快
- ✅ 支持 glob 模式和正则表达式
- ❌ 搜索路径硬编码为 `data/markdown`
- ❌ 功能相对基础，无上下文理解

**适用场景**:
- 精确的文件名匹配
- 正则表达式文本搜索
- 需要快速搜索大量文件

### 2. create_local_file_search_tools (351行)

**类型**: 自定义工具（基于 `LocalFileSearchTool`）

**提供的工具**:
- `search_local_files_by_keywords`: 智能关键词搜索
- `get_file_content`: 根据行号获取文件内容

**特点**:
- ✅ 智能关键词搜索，支持上下文扩展
- ✅ 针对 markdown 文件优化（MarkdownNodeParser）
- ✅ 支持 markdown 块提取和按比例扩展上下文
- ✅ Token 限制和结果过滤
- ✅ 搜索路径可配置（`settings.local_file_search_dir`）
- ✅ 有结果过滤机制（文件数、匹配数限制）
- ❌ 相对较慢（需要解析 markdown）

**适用场景**:
- 语义化的关键词搜索
- 需要上下文理解
- 需要获取完整的 markdown 块
- 需要精确的行号定位

## 功能对比表

| 特性 | FilesystemFileSearchMiddleware | LocalFileSearchTool |
|------|-------------------------------|---------------------|
| 文件名匹配 | ✅ glob_search | ❌ |
| 正则文本搜索 | ✅ grep_search | ❌ |
| 关键词搜索 | ❌ | ✅ |
| 上下文扩展 | ❌ | ✅ (markdown块/比例扩展) |
| 行号定位 | ❌ | ✅ |
| Token 管理 | ❌ | ✅ |
| 结果过滤 | ❌ | ✅ |
| 搜索速度 | ⚡ 快 (ripgrep) | 🐌 较慢 (需要解析) |
| 路径配置 | ❌ 硬编码 | ✅ 可配置 |
| Markdown 优化 | ❌ | ✅ |

## 建议

### 方案1: 保留两者（推荐）

**理由**:
1. **互补性强**: 两者功能不重叠，可以互补
   - `FilesystemFileSearchMiddleware`: 精确匹配场景
   - `LocalFileSearchTool`: 语义化搜索场景

2. **使用策略**:
   - 优先使用 `LocalFileSearchTool`（已在 system prompt 中指导）
   - `FilesystemFileSearchMiddleware` 作为补充，用于：
     - 精确的文件名搜索
     - 正则表达式搜索
     - 快速全文搜索

3. **需要优化**:
   - 统一搜索路径配置，避免硬编码
   - 更新 system prompt，说明何时使用哪个工具

### 方案2: 只保留 LocalFileSearchTool

**适用场景**:
- 如果主要使用场景是语义化搜索
- 不需要精确的文件名匹配
- 不需要正则表达式搜索

**优点**:
- 工具更少，agent 选择更简单
- 统一的搜索接口

**缺点**:
- 失去精确匹配能力
- 失去快速全文搜索能力

### 方案3: 只保留 FilesystemFileSearchMiddleware

**不推荐**，因为：
- 失去智能关键词搜索能力
- 失去上下文扩展能力
- 失去 markdown 优化能力

## 推荐优化方案

### 1. 统一搜索路径配置

```python
# 在 config.py 中确保有配置
local_file_search_dir: str = "data/markdown"  # 或从环境变量读取

# 在 min_langchain_agent.py 中使用配置
FilesystemFileSearchMiddleware(
    root_path=settings.local_file_search_dir or "data/markdown",
    use_ripgrep=True,
    max_file_size_mb=10,
),
```

### 2. 更新 System Prompt

在 `agent_system_prompt` 中添加工具使用指导：

```python
工具使用策略：
1. 首先尝试使用rag_search工具在文档和FAQ中搜索
2. 如果rag_search未找到，使用search_local_files_by_keywords进行智能关键词搜索
3. 如果需要精确的文件名匹配或正则表达式搜索，使用glob_search或grep_search
4. 使用get_file_content获取已找到文件的详细内容
```

### 3. 考虑添加工具描述

确保 agent 能理解何时使用哪个工具，可以在工具描述中明确说明。

## 结论

**建议保留两者**，因为它们功能互补：
- `LocalFileSearchTool`: 主要工具，用于智能搜索
- `FilesystemFileSearchMiddleware`: 补充工具，用于精确匹配

但需要：
1. 统一搜索路径配置
2. 更新 system prompt 说明工具使用场景
3. 确保路径配置一致
